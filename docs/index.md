# Добро пожаловать в гайд по настройке VPN на роутере

[Краткое описание]

## Этап 1: Приобретение Keenetic роутера

* Купить Keenetic роутер можно в [официальном магазине](https://shop.keenetic.ru/collection/main?characteristics%5B%5D=69931032&characteristics%5B%5D=69931147). 
* Не покупайте Mesh-ретранслятор (Keenetic Buddy) в качестве роутера. Вы не сможете настроить на нем VPN, потому что он не является роутером. 
* Если вы не знаете какая модель роутера подходит именно вам, пройдите [этот гайд](https://keenetic.ru/ru/find-my-keenetic) от Keenetic.
* Выполните базовые настройки роутера с помощью ["Мастера быстрой настройки"](https://help.keenetic.com/hc/ru/articles/360000026919-%D0%9C%D0%B0%D1%81%D1%82%D0%B5%D1%80-%D0%B1%D1%8B%D1%81%D1%82%D1%80%D0%BE%D0%B9-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B8)

### FAQ

    Q. На какой моделе роутера Keenetic будет работать VPN? 
    A. На любой моделе Keenetic роутера можно настроить VPN

    Q. Можно ли использовать роутер от другой компании для настройки VPN? 
    A. Технически можно настроить VPN на роутере от другой компании, если этот роутер поддерживает прошивку OpenWRT. Однако для такой настройки требуются глубокие познания в устройстве роутеров и компьютерных сетей. Мы не будем рассматривать настройку этих роутеров в данной инструкции.  

## Этап 2: Установка VPN соединения Wireguard на роутере

### Шаг 1

Откройте в веб-браузере, страницу управления роутером. Чаще всего, адрес страницы управления: http://192.168.1.1 или http://192.168.0.1 Как альтернатива, для роутеров Keenetic, можно открыть сайт: http://my.keenetic.net

    Имя пользователя по умолчанию: admin.
    Если вам не известен пароль, в некоторых случаях он может быть указан на обратной стороне роутера. Часто встречаются простые пароли по-умолчанию, например, admin или 1234.

![img.png](images/img_0.png)

### Шаг 2

Сразу после авторизации, перейдите в раздел "Управление", далее "Параметры системы", разверните пункт "startup-config" и сохраните резервную копию нынешних настроек вашего роутера.

![img.png](images/img_5.png)

### Шаг 3

Проверьте какая версия KeeneticOS установлена на роутере, и предлагается ли обновление KeeneticOS до версии 4.2., так как поддержка WireGuard с параметрами asc, в KeeneticOS, появилась начиная с версии 4.2 Alpha 2. Если для вашего роутера ещё не вышел релиз KeeneticOS 4.2, попробуйте переключить канал обновления, на "Предварительный".

![img_1.png](images/img_1.png)

### Шаг 4

Если уже установлена версия KeeneticOS 4.2, или предлагается обновление до 4.2, нужно проверить наличие необходимого компонента системы. Нажмите кнопку "Изменить набор компонентов".

![img_2.png](images/img_2.png)

### Шаг 5

На открывшейся странице "Компоненты операционной системы", в секции "Сетевые функции", проверьте наличие установленного компонента "WireGuard VPN" Если компонент "WireGuard VPN" не установлен, отметьте соответствующий чек-бокс для установки, и нажмите появившуюся снизу кнопку "Обновить KeeneticOS". Дождитесь, пока роутер обновится и перезагрузится.

![img_3.png](images/img_3.png)

### Шаг 6

После чего выполните обновление роутера до версии 4.2 или новее, нажав кнопу "Обновить KeeneticOS" на странице "Параметры системы". В процессе обновления, роутер выполнит перезагрузку.

    Если обновление прерывается с сообщением "Недостаточно места", нужно в списке компонентов отключить ненужные, чтобы уменьшить размер обновления.

![img_4.png](images/img_4.png)

### Шаг 7

После обновления и перезагрузки роутера, нужно заново авторизоваться на странице управления роутером.

![img.png](images/img_6.png)

### Шаг 8

Убедитесь, что KeeneticOS обновилась до версии 4.2, и что необходимый компонент "WireGuard VPN", установлен.

![img.png](images/img_7.png)

### Шаг 9

Теперь, Вам потребуется файл конфигурации AmneziaWG в нативном формате (т.е. файл, с расширением .conf).

    Один файл одновременно можно использовать только на одном устройстве! При наличии подписки Amnezia Premium, файл в нативном формате, можно запросить в боте поддержки для Premium. При использовании self-hosted решения, файл можно сгенерировать в приложении AmneziaVPN, в разделе "Поделиться" (Второй слева значок нижней панели), выбрав в качестве формата подключения - "Оригинальный формат AmneziaWG", и нажав кнопку "Поделиться", в самом низу.

### Шаг 10

Найдите и откройте только что сохранённый файл конфигурации в какой-нибудь текстовой программе, например в "Блокноте".

![img.png](images/img_8.png)

### Шаг 11

Из данного файла Вам понадобятся значения параметров Jc, Jmin, Jmax, S1, S2, H1, H2, H3, H4 - это asc параметры.

![img.png](images/img_9.png)

### Шаг 12

Теперь, Вам нужно вернуться к настройкам роутера, и перейти в раздел Интернет и выбрать "Другие подключения".

![img_1.png](images/img_10.png)

### Шаг 13

Выберите секцию Wireguard, в ней создайте новое подключения, импортировав сохранённый файл конфигурации AmneziaWG. Для этого нажмите на ссылку "Загрузить из файла"

![img_2.png](images/img_11.png)

### Шаг 14

В появившемся окне файлового менеджера, перейдите в папку, где Вы сохранили файл конфигурации AmneziaWG, выберите его, и нажмите кнопку "Открыть".

![img_3.png](images/img_12.png)

### Шаг 15

Через несколько секунд, в секции Wireguard, должно появится новое соединение, с таким же названием, как было у импортированного файла. Но использовать появившееся подключение, еще рано. Нужно зайти в его настройки для редактирования, щелкнув по его строке в любом месте, кроме свитчера.

    Внутренний IP-адрес созданного подключения, должен быть уникальным, среди других имеющихся соединений Wireguard. Иначе, эти соединения, будут конфликтовать. В такой ситуации, для одного из конфликтующих соединений, потребуется создать другой (новый) файл конфигурации, с другим IP-адресом.

![img_4.png](images/img_13.png)

### Шаг 16

В открывшемся окне настроек подключения, отметь чек-бокс "Использовать для выхода в интернет", после чего сохраните внесённые изменения, нажав кнопку "Сохранить", внизу страницы с настройками.

    Если у Вас есть несколько соединений, с одинаковым названием, стоит переименовать их так, чтобы название только что созданного подключения WireGuard, стало уникальным.

![img_5.png](images/img_14.png)

### Шаг 17

Теперь Вам нужно, перейти в веб-версию командной строки роутера Keenetic, для выполнения ряда команд. Для этого необходимо перейти в настройки, нажать на изображение шестеренки, в правом верхнем углу веб-страницы, и перейти по ссылке "Командная строка".

![img_6.png](images/img_15.png)

### Шаг 18

Введите команду show interface и нажмите кнопку "Отправить запрос". Ниже, отобразится информация обо всех имеющихся интерфейсах.

![img_7.png](images/img_16.png)

### Шаг 19

Теперь нужно узнать имя нужного интерфейса, по названию созданного ранее подключения. Для этого, откройте поиск по странице (это можно сделать, одновременно нажав две клавиши, Ctrl+F). Введите для поиска, название созданного ранее подключения. В данном примере, это amnezia_for_awg . Должно быть найдено одно, уникальное название в поле "description". А рядом с ним, будет находится другое поле, "interface-name", в котором отображается имя нужного интерфейса. В данном примере, это Wireguard1 .

![img_8.png](images/img_17.png)

### Шаг 20

Теперь, зная имя интерфейса и значения параметров asc из файла в формате .conf который мы сохранили ранее. Нужно заменить все значения шаблона в скобках, Вашими значениями, а сами скобки удалить.

interface {name} wireguard asc {jc} {jmin} {jmax} {s1} {s2} {h1} {h2} {h3} {h4}

В данном примере, строка примет вид:

interface Wireguard1 wireguard asc 8 50 1000 30 32 1811016522 1196729875 457766807 1765857463

Получившуюся строку, нужно вставить в вэб-версии командной строки роутера, и нажать кнопку "Отправить запрос". Если Вы ввели правильную команду, ниже будет выведен результат обработки запроса, как на приведённом скриншоте.

![img_9.png](images/img_18.png)

### Шаг 21

Теперь, следует сохранить изменения в конфигурации роутера. Введите команду system configuration save, и нажмите "Отправить запрос". Если всё введено верно, ниже будет выведен результат обработки запроса, как на приведённом скриншоте.

![img_10.png](images/img_19.png)

### Шаг 22

Теперь нужно перейти в раздел "Интернет", далее "Другие подключения", и проверить работоспособность созданного подключения WireGuard, переключив его состояние на "Включено". Через несколько секунд, отметка активности пира, должна изменить цвет с серого, на зелёный. Также, должна отобразиться информация о входящем/исходящем трафике, и о времени с последнего "рукопожатия".

    В случае каких либо проблем с подключением, ещё раз проверьте все проделанные действия и введённые параметры. Также, можно прейти в раздел Управление -> Диагностика -> Показать журнал.

![img_11.png](images/img_20.png)

### Шаг 23

Если подключение установилось успешно, нужно перейти в раздел "Интернет" - "Приоритеты подключения".

![img_12.png](images/img_21.png)

### Шаг 24

В настройках Политик доступа в Политике по умолчанию созданное VPN-подключение (amnezia_for_awg) должно идти ниже вашего основного интернет-подключения, чтобы избежать проблем с переподключением роутера при обрыве основного интернет-соединения.

![img_13.png](images/img_22.png)

### Этап 3: Настройка маршрутизации VPN соединения

### Шаг 1 (пойдет ВЫШЕ на этапе 2!!!!!!)

Установите систему пакетов репозитория Entware.

1. Установка Wireguard на Keenetic роутер (шаги 11-13 не нужны, если используем не свой виртуальный сервер, а общий. Для использования общего сервака попросить у меня VPN конфиг. Шаги 27 и далее не нужны): https://docs.amnezia.org/ru/documentation/instructions/keenetic-os-awg/
2. Настройка статической маршрутизации (2.1) или динамической маршрутизации (2.2), чтобы роутер автоматически определял для каких серверов использовать VPN, а для каких не использовать. Нужно настроить либо только 2.1, либо только 2.2. При настройке 2.1 может не работать Netflix на телеках и консолях, а придется ~1 раз в год перенастраивать статическую маршрутизацию. 
2.1. Настройка маршрутизации на Keenetic (начиная с "Как добавить маршрут в роутер Keenetic"): https://rockblack.su/vpn/dopolnitelno/diapazon-ip-adresov
2.2. Этот способ сложнее!!! Преднастройку роутера выполнить по этому видео. Инструкция по настройке KVAS тут.
